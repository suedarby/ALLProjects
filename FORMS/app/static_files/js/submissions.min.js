_.each(["Model","Collection"],function(a){var c=Backbone[a];var b=c.prototype.fetch;c.prototype.fetch=function(){this.trigger("fetch",this);return b.apply(this,arguments)}});Backbone.View.prototype.close=function(){this.remove();this.unbind();if(this.onClose){this.onClose()}};_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var App=App||{};App.Options={sort_attribute:"-created_at",resizeColumns:false,showColumns:true,minimumCountColumns:2,defaultNumberOfColumns:5,columns:{},emptyFields:0};App.set=function(a,b){if(typeof(Storage)!=="undefined"){localStorage.setItem(a,JSON.stringify(b))}else{$.cookie(a,JSON.stringify(b),{expires:365})}};App.get=function(a){if(!_.isNull(localStorage.getItem(a))){return JSON.parse(localStorage.getItem(a))}else{if(!_.isUndefined($.cookie(a))){return JSON.parse($.cookie(a))}}return{}};App.remove=function(a){localStorage.removeItem(a);$.cookie(a,null)};App.SubmissionsView=Backbone.View.extend({className:"submissions",subViews:{},template:_.template($("#submissionsTemplate").html()),initialize:function(){this.listenTo(this.collection,"fetch",this.showProgress);this.listenTo(this.collection,"sync",this.onSync)},events:{"keyup input.searchTxt":function(a){a.preventDefault();if(a.keyCode===13){this.collection.searchPage(a.currentTarget.value)}return false},"click button#refreshBtn":function(a){a.preventDefault();$.post(options.settingsEndPoint,{form_id:options.formID,settings:""});location.reload()},"click button.searchBtn":function(a){a.preventDefault();this.collection.searchPage($("input.searchTxt").val());return false},"click a#filter-link":function(a){a.preventDefault();this.collection.filterPage($(a.currentTarget).attr("data-start"),$(a.currentTarget).attr("data-end"));return false},"click input.column":function(c){c.stopImmediatePropagation();var d=this.$(c.currentTarget);var a=d.val();this.$("tr.submission div:nth-child("+a+"),th:nth-child("+a+")").toggle();var b=d.data("key");App.Options.columns[b]=d.is(":checked");$.post(options.settingsEndPoint,{form_id:options.formID,settings:JSON.stringify(App.Options)});this.checkMinimumCountColumns()},"click button.resizeColumns":function(a){a.preventDefault();this.$("button.resizeColumns").toggle();this.$("table.table").toggleClass("table-fullsize");App.Options.resizeColumns=!App.Options.resizeColumns;App.set("form_"+options.formID+"_options",App.Options);return false},"click input#allRows":function(a){a.stopImmediatePropagation();var b=!this.$("input.row").prop("checked");this.$("input.row").prop("checked",b)},"click a#markAsRead":function(b){b.preventDefault();var a=[];var c=this.$("input.row:checked");_.map(c,function(d){a.push($(d).data("id"))});if(a.length>0){this.collection.updateModelsByIds(a,{"new":0})}},"click a#markAsUnread":function(b){b.preventDefault();var a=[];var c=this.$("input.row:checked");_.map(c,function(d){a.push($(d).data("id"))});if(a.length>0){this.collection.updateModelsByIds(a,{"new":1})}},"click a#deleteSelectedRows":function(c){c.preventDefault();var a=this;var b=[];var d=this.$("input.row:checked");_.map(d,function(e){b.push($(e).data("id"))});if(b.length>0){krajeeDialog.confirm(options.i18n.areYouSureDeleteItems,function(e){if(e){a.collection.destroyModelsByIds(b)}})}},"click a#submitted_at":function(b){b.preventDefault();var a=this.collection.sort_attribute=="-created_at"?"created_at":"-created_at";this.collection.sortPage(a);return false},"click .field-name":function(b){b.preventDefault();var c=this.$(b.currentTarget).attr("data-field-name");var a=this.collection.sort_attribute=="-"+c?c:"-"+c;this.collection.sortPage(a);return false}},onSync:function(b,c,a){if(_.isObject(b.models)){this.render()}},addSubview:function(b,c,a){if(b.get("data")){this.subViews[b.cid]=new App.SubmissionView({model:b});this.$("tbody").append(this.subViews[b.cid].render().el)}else{this.collection.destroyModelsByIds([b.get("id")])}},showProgress:function(){this.$("#loading").show()},hideProgress:function(){this.$("#loading").hide()},closeSubviews:function(){_.invoke(this.subViews,"close")},onClose:function(){this.closeSubviews();this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},checkMinimumCountColumns:function(){if(this.$("input.column:checked").length<=App.Options.minimumCountColumns){this.$("input.column:checked").prop("disabled",true)}else{this.$("input.column:checked").prop("disabled",false)}},toggleColumns:function(){if(App.Options.showColumns){var a=this;var c=_.map(options.fields,function(d){return d.name});c.unshift("index","number","id");var b=App.Options.columns;if(_.isEmpty(b)||((_.keys(b)).length<c.length)){_.each(c,function(g,f){if(f!==0&&f<App.Options.defaultNumberOfColumns){b[g]=true}else{b[g]=false}var h=a.$('input[data-key="'+g+'"]');var d=b[g];if(d){h.prop("checked",d)}else{var e=h.val();a.$("tr.submission div:nth-child("+e+"),th:nth-child("+e+")").hide();h.prop("checked",d)}})}else{_.each(c,function(f){var g=a.$('input[data-key="'+f+'"]');var e=g.val();var d=b[f];if(d){g.prop("checked",d)}else{a.$("tr.submission div:nth-child("+e+"),th:nth-child("+e+")").hide();g.prop("checked",d)}});this.checkMinimumCountColumns()}}else{this.$("input.column:checked").prop("disabled",true)}},resizeColumns:function(){if(App.Options.resizeColumns){this.$("button.resizeColumns").eq(0).hide();this.$("button.resizeColumns").eq(1).show();this.$("table.table").toggleClass("table-fullsize")}},initDatePicker:function(){var d=this;var e=options.dateFormat;var f=this.collection.startDate;var c=this.collection.endDate;if(_.isEmpty(f)||_.isEmpty(c)){f=moment().subtract(29,"days");c=moment()}else{f=moment.unix(f);c=moment.unix(c)}function a(i,g){d.$("#date-range").text(i.format(e)+" - "+g.format(e));d.$("#filter-link").attr("data-start",i.unix());d.$("#filter-link").attr("data-end",g.unix());var h=$.param({start:i.unix(),end:g.unix()});d.$("#csv-link").attr("href",options.csvEndPoint+"&"+h);d.$("#xlsx-link").attr("href",options.xlsxEndPoint+"&"+h)}var b=[];b[options.i18n.today]=[moment(),moment()];b[options.i18n.yesterday]=[moment().subtract(1,"days"),moment().subtract(1,"days")];b[options.i18n.last7Days]=[moment().subtract(6,"days"),moment()];b[options.i18n.last30Days]=[moment().subtract(29,"days"),moment()];b[options.i18n.thisMonth]=[moment().startOf("month"),moment().endOf("month")];b[options.i18n.lastMonth]=[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")];this.$("#range").daterangepicker({startDate:f,endDate:c,showDropdowns:true,linkedCalendars:false,locale:{customRangeLabel:options.i18n.customRange,applyLabel:options.i18n.apply,cancelLabel:options.i18n.clear},language:options.language,ranges:b},a);this.$("#range").on("cancel.daterangepicker",function(h,g){d.$("#date-range").text("");d.$("#csv-link").attr("href",options.csvEndPoint);d.$("#xlsx-link").attr("href",options.xlsxEndPoint)});a(f,c)},render:function(){this.closeSubviews();this.hideProgress();this.el.innerHTML=this.template(this.collection.getPage());this.$("input.searchTxt").val(this.collection.keywords);this.collection.each(this.addSubview.bind(this));this.subViews.paginationView=new App.PaginationView({collection:this.collection});this.$("#pagination").append(this.subViews.paginationView.render().el);this.toggleColumns();this.resizeColumns();this.initDatePicker();return this}});App.SubmissionView=Backbone.View.extend({template:_.template($("#submissionTemplate").html()),tagName:"tr",className:"submission",events:{"click .view":"viewModel","click .edit":"editModel","click .remove":"removeModel"},viewModel:function(a){a.preventDefault();App.Router.navigate("view/"+this.model.id,{trigger:true})},editModel:function(a){a.preventDefault();App.Router.navigate("edit/"+this.model.id,{trigger:true})},removeModel:function(b){b.preventDefault();var a=this;krajeeDialog.confirm(options.i18n.areYouSureDeleteItem,function(c){if(c){a.model.destroy({wait:true})}});return false},onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},render:function(){var c=this.model.collection.indexOf(this.model)+this.model.collection.pager.range.min;var h=this.model.get("id");var e=this.model.get("number");var d=this.model.get("hashId");var a=this.model.get("new");var g=this.model.get("created");var f=this.model.get("data");if(!_.isObject(f)){f=JSON.parse(f)}this.el.innerHTML=this.template({index:c,id:h,number:e,hashId:d,isNew:a,data:f,created_at:g});var b=this;b.$('div[data-key*="selectlist"], div[data-key*="checkbox"], div[data-key*="matrix"]').each(function(i,j){b.$(j).text(function(k,l){return l.replace(/,/g,", ")})});return this}});App.DetailView=Backbone.View.extend({tagName:"div",className:"detailView",template:_.template($("#detailTemplate").html()),initialize:function(b){if(_.isObject(this.model)){this.modelExists=true}else{var a=this;this.model=new Submission();this.model.id=b.id;this.model.url=function(){return options.hasPrettyUrls?options.endPoint+"/"+b.id:options.deleteEndPoint+"&id="+b.id};this.model.fetch({success:function(d,c){a.modelExists=true;a.render()}})}},events:{"click .edit":"editModel","click .remove":"removeModel","click .removeFile":"removeFileModel","click #addComment":"addCommentModel","click .deleteComment":"deleteCommentModel","click #showEmptyFields":"showEmptyFields","click .sendConfirmation":"sendConfirmation","click .sendNotification":"sendNotification"},editModel:function(a){a.preventDefault();App.Router.navigate("edit/"+this.model.id,{trigger:true})},removeModel:function(b){b.preventDefault();var a=this;krajeeDialog.confirm(options.i18n.areYouSureDeleteItem,function(c){if(c){a.model.destroy({wait:true,success:function(){App.Router.navigate("",{trigger:true})}})}});return false},removeFileModel:function(b){b.preventDefault();var a=this;krajeeDialog.confirm(options.i18n.areYouSureDeleteFileItem,function(d){if(d){var c=$(b.currentTarget).data("id");$.ajax({url:options.deleteFileEndPoint,type:"POST",data:{submission_id:a.model.get("id"),file_id:c}}).done(function(e){if(e.success){$("tr[data-file='"+e.fileID+"']").remove();a.model.fetch()}else{alert(options.i18n.errorOnDelete)}}).fail(function(e,f){alert(options.i18n.errorOnDelete)})}});return false},addCommentModel:function(b){b.preventDefault();var a=this;$.ajax({url:options.addCommentEndPoint,type:"POST",data:{submission_id:this.model.get("id"),comment:$("#commentContent").val()}}).done(function(e){if(e.id){var c=a.model.get("comments");c.push(e);var d=_.uniq(c,function(f){return f.id});a.model.set("comments",d);a.render()}else{alert(options.i18n.errorOnUpdate)}}).fail(function(c,d){alert(options.i18n.errorOnUpdate)})},deleteCommentModel:function(b){b.preventDefault();var a=this;krajeeDialog.confirm(options.i18n.areYouSureDeleteCommentItem,function(c){if(c){var d=$(b.currentTarget).data("id");$.ajax({url:options.deleteCommentEndPoint,type:"POST",data:{submission_id:a.model.get("id"),comment_id:d}}).done(function(g){if(g.success){$("li[data-comment-id='"+g.commentID+"']").remove();var e=a.model.get("comments");var f=_.reject(e,function(h){return h.id==g.commentID});a.model.set("comments",f);a.render()}else{alert(options.i18n.errorOnDelete)}}).fail(function(e,f){alert(options.i18n.errorOnDelete)})}});return false},showEmptyFields:function(a){App.Options.emptyFields=$(a.currentTarget).is(":checked")?1:0;$.post(options.settingsEndPoint,{emptyFields:App.Options.emptyFields});this.render()},sendConfirmation:function(b){b.preventDefault();var a=this;krajeeDialog.confirm(options.i18n.areYouSureSendConfirmation,function(c){if(c){$.ajax({url:options.emailEndPoint,type:"POST",data:{sid:a.model.get("id"),type:"CONFIRMATION"}}).done(function(d){alert(d.message)}).fail(function(){alert(options.i18n.errorOnEmail)})}});return false},sendNotification:function(b){b.preventDefault();var a=this;krajeeDialog.confirm(options.i18n.areYouSureSendConfirmation,function(c){if(c){$.ajax({url:options.emailEndPoint,type:"POST",data:{sid:a.model.get("id"),type:"NOTIFICATION"}}).done(function(d){alert(d.message)}).fail(function(){alert(options.i18n.errorOnEmail)})}});return false},onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},afterAppend:function(){if(_.isObject(this.map)&&typeof google!=="undefined"){var a=this.map.getCenter();google.maps.event.trigger(this.map,"resize");this.map.setCenter(a);this.map.setZoom(12)}else{if(_.isObject(this.map)){this.map.invalidateSize()}}var b=this.$(".commentList");if(b.length){this.$(b).scrollTop(b[0].scrollHeight)}},onRender:function(){var b={};this.$("table th.file-field-label").each(function(){var c=$(this).text();if(b[c]){$(this).text("")}else{b[c]=true}});if(this.model.get("new")===1){this.model.set({"new":0});$.ajax({url:options.readEndPoint,type:"POST",data:{fid:options.formID,id:this.model.get("id")}})}var a=this.$(".commentList");if(a.length){this.$(a).scrollTop(a[0].scrollHeight)}},render:function(){if(this.modelExists){var n=this.model.get("id");var p=this.model.get("hashId");var a=this.model.get("number");var e=this.model.get("authorName");var l=this.model.get("lastEditorName");var b=this.model.get("created");var r=this.model.get("updated");var j=this.model.get("ip");var s=this.model.get("editLink");var c=this.model.get("sender");var q=this.model.get("data");var f=App.Options.emptyFields?"checked":"";var g=this.model.get("files");var h=this.model.get("comments");if(!_.isEmpty(g)){var d=_.keys(options.fileFields);var k=[];d.forEach(function(t){_.each(g,function(u){if(u.field===t){k.push(u)}})});g=k}if(!_.isObject(c)){c=JSON.parse(c)}if(!_.isObject(q)){q=JSON.parse(q)}this.el.innerHTML=this.template({id:n,hashId:p,number:a,form_name:options.formName,data:q,files:g,comments:h,author:e,lastEditor:l,created_at:b,updated_at:r,sender:c,ip:j,editLink:s,showEmptyFields:f});var m=this;m.$(".table-detail").find('td[data-key*="selectlist"], td[data-key*="checkbox"], td[data-key*="matrix"]').each(function(t,u){m.$(u).text(function(v,w){return w.replace(/,/g,", ")})});if(_.isNumber(c.latitude)&&_.isNumber(c.longitude)&&typeof google!=="undefined"){var i=new google.maps.LatLng(c.latitude,c.longitude);var o={center:i,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(this.$el.find("#map")[0],o);this.marker=new google.maps.Marker({position:i,map:this.map,title:"Sender Location"})}else{if(_.isNumber(c.latitude)&&_.isNumber(c.longitude)&&typeof L!=="undefined"){this.map=L.map(this.$("#map")[0]).setView([c.latitude,c.longitude],13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.map);L.marker([c.latitude,c.longitude]).addTo(this.map)}}this.onRender()}return this}});App.BulkView=Backbone.View.extend({tagName:"div",template:_.template($("#bulkTemplate").html()),onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},render:function(){this.el.innerHTML=this.template();return this}});App.FormView=Backbone.View.extend({modelExists:false,tagName:"div",template:_.template($("#formTemplate").html()),events:{"submit #form-app":"saveModel"},initialize:function(b){this.subtitle=b.subtitle;if(_.isObject(this.model)){this.modelExists=true}else{if(!_.isUndefined(b.id)){var a=this;this.model=new Submission();this.model.id=b.id;this.model.url=function(){return options.hasPrettyUrls?options.endPoint+"/"+b.id:options.deleteEndPoint+"&id="+b.id};this.model.fetch({success:function(d,c){a.modelExists=true;a.render()}})}}},saveModel:function(d){d.preventDefault();var c=$('[type="file"]');var e={};var b=_.map(options.fields,function(f){return f.name});$.each(b,function(h,i){var k=i.split("_",1);var g=k[0];var f=[];if(g==="selectlist"){$('select[name="'+i+'[]"] option:selected').each(function(){f.push(this.value)});e[i]=f}else{if(g==="checkbox"){$('input[name="'+i+'[]"]:checked').each(function(){f.push(this.value)});e[i]=f}else{if(g==="radio"){$('input[name="'+i+'"]:checked').each(function(){e[i]=this.value})}else{if(g==="matrix"){var j=$("#"+i);if(j.length===0||!j.is(":input")){j=$('input[name="'+i+'"]');if(j.length===0){j=$('input[name="'+i+'[]"]')}}if(j.is(":radio")){$('input[name="'+i+'"]:checked').each(function(){e[i]=this.value})}else{if(j.is(":checkbox")){$('input[name="'+i+'[]"]:checked').each(function(){f.push(this.value)});e[i]=f}else{if(j.is("select")){$('select[name="'+i+'[]"] option:selected').each(function(){f.push(this.value)});e[i]=f}else{e[i]=$("#"+i).val()}}}}else{if(g==="signature"){e[i]=$('input[name="'+i+'"]').val()}else{e[i]=$("#"+i).val()}}}}}});if(!_.isEmpty(e)||c.length>0){var a=this;if(this.modelExists){c.each(function(){var i=$(this).attr("name");var f=Backbone.Model.extend({url:options.uploadEndPoint+"&s_id="+a.model.get("id"),fileAttribute:i});var h=new f();var g=$(this)[0].files;if(!_.isUndefined(g)){$(window).off("beforeunload").on("beforeunload",function(){return options.i18n.uploadingFile});h.set(i,g);h.save({},{success:function(n,l){var k=a.model.get("files");if(l.length>0){var j=_.filter(k,function(o){return o.field!==i.replace("[]","")});var m=_.union(j,l);a.model.set("files",m)}}});h.on("progress",function(j){if(j===1){$(window).off("beforeunload")}})}});this.model.save({data:e},{success:function(){App.Router.navigate("",{trigger:true})},error:function(g,f){alert(f.statusText)}})}else{this.collection.create({form_id:options.formID,data:e},{wait:true,error:function(g,f){alert(f.statusText)},success:function(f){c.each(function(){var j=$(this).attr("name");var g=Backbone.Model.extend({url:options.uploadEndPoint+"&s_id="+f.get("id"),fileAttribute:j});var i=new g();var h=$(this)[0].files;if(typeof h!=="undefined"){$(window).off("beforeunload").on("beforeunload",function(){return options.i18n.uploadingFile});i.set(j,h);i.save({},{success:function(l,k){a.collection.firstPage()}});i.on("progress",function(k){if(k===1){$(window).off("beforeunload")}})}})}})}}},onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},render:function(){this.el.innerHTML=this.template({form_name:options.formName,subtitle:this.subtitle});if(this.modelExists){this.populateDataInForm()}var a=this.$('[type="file"]');a.removeAttr("required");a.parents(".form-group").removeClass("required-control");return this},populateDataInForm:function(){var a=this;var c=a.model.get("data");if(!_.isObject(c)){c=JSON.parse(c)}var b=_.map(options.fields,function(d){return d.name});$.each(b,function(h,l){var f=l.split("_",1);var d=f[0];if(d==="selectlist"){var g=c[l];a.$('select[name="'+l+'[]"] option:selected').prop("selected",false);a.$('select[name="'+l+'[]"]').each(function(){var m=a.$(this);if(typeof g==="string"){a.$('select[name="'+l+'[]"] option[value="'+g+'"]').prop("selected",true)}else{if(Array.isArray(g)){$.each(g,function(n,o){a.$('select[name="'+l+'[]"] option[value="'+o+'"]').prop("selected",true)})}}})}else{if(d==="checkbox"){var e=c[l];a.$('input[name="'+l+'[]"]').prop("checked",false).each(function(){var m=a.$(this);if(typeof e!=="undefined"){$.each(e,function(n,o){if(m.val()===o){m.prop("checked",true)}})}})}else{if(d==="radio"){a.$('input[name="'+l+'"]').each(function(m,o){var n=a.$(o);if(n.val()===c[l]){n.prop("checked",true)}})}else{if(d==="date"){var j=a.$("#"+l);if(j.attr("type")==="date"){if(c[l]!==""){a.$("#"+l).val(moment(c[l],options.dateFormat).format("YYYY-MM-DD"))}}else{if(j.attr("type")==="datetime-local"){if(c[l]!==""){a.$("#"+l).val(moment(c[l],options.dateTimeFormat).format("YYYY-MM-DDTHH:mm"))}}else{a.$("#"+l).val(c[l])}}}else{if(d==="matrix"){var j=a.$("#"+l);if(j.length===0||(j.not("input")&&!j.is("select")&&!j.is("textarea"))){j=a.$('input[name="'+l+'"]');if(j.length===0){j=a.$('input[name="'+l+'[]"]')}}if(j.is("select")){var g=c[l];a.$('select[name="'+l+'[]"] option:selected').prop("selected",false);a.$('select[name="'+l+'[]"]').each(function(){var m=a.$(this);if(typeof g==="string"){a.$('select[name="'+l+'[]"] option[value="'+g+'"]').prop("selected",true)}else{if(Array.isArray(g)){$.each(g,function(n,o){a.$('select[name="'+l+'[]"] option[value="'+o+'"]').prop("selected",true)})}}})}else{if(j.is(":radio")){j.each(function(m,o){var n=a.$(o);if(n.val()===c[l]){n.prop("checked",true)}})}else{if(j.is(":checkbox")){var e=c[l];a.$('input[name="'+l+'[]"]').prop("checked",false).each(function(){var m=a.$(this);$.each(e,function(n,o){if(m.val()===o){m.prop("checked",true)}})})}else{j.val(c[l])}}}}else{if(l.substring(0,16)==="hidden_signature"){var k=a.$("#"+l).closest("div").find("canvas");if(k.length>0){for(var i=0;i<k.length;i++){(function(m){var s=new SignaturePad(m);if(typeof c[l]!=="undefined"&&c[l]){var n=JSON.parse(c[l]);s.fromData(n.data)}var q=s.canvas.id;var t="#hidden_"+q;var p="#clear_"+q;var u="#undo_"+q;var o=function(){var v={data:s.toData(),dataURL:s.toDataURL()};a.$(t).val(JSON.stringify(v));a.$(t).trigger("change")};a.$(t).val(c[l]);s.onEnd=function(){o()};var r=a.$("#"+q).data("color");if(r&&r.length>0&&r!=="black"){s.penColor=r}a.$(p).on("click",function(){s.clear();a.$(t).val("")});a.$(u).on("click",function(){var v=s.toData();if(Array.isArray(v)&&v.length){v.pop();s.fromData(v);o()}})})(k[i])}}}else{a.$("#"+l).val(c[l])}}}}}}});return this}});App.NavView=Backbone.View.extend({template:_.template($("#navTemplate").html()),page:"Submissions",initialize:function(a){this.page=a.page},onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},render:function(){this.el.innerHTML=this.template({page:this.page});return this}});App.PaginationView=Backbone.View.extend({template:_.template($("#paginationTemplate").html()),tagName:"div",className:"kv-panel-pager",initialize:function(){_.bindAll(this,"previous","next");this.listenTo(this.collection,"sync:page",this.render)},events:{"click a.first":"first","click a.prev":"previous","click a.next":"next","click a.last":"last"},onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},render:function(){this.el.innerHTML=this.template(this.collection.getPage());return this},isDisabled:function(a){return this.$(a.currentTarget).parent().hasClass("disabled")},first:function(a){a.preventDefault();if(!this.isDisabled(a)){this.collection.firstPage()}return false},previous:function(a){a.preventDefault();if(!this.isDisabled(a)){this.collection.previousPage()}return false},next:function(a){a.preventDefault();if(!this.isDisabled(a)){this.collection.nextPage()}return false},last:function(a){a.preventDefault();if(!this.isDisabled(a)){this.collection.lastPage()}return false}});var Submission=Backbone.Model.extend({url:function(){var a=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew()){return a}return a+(a.charAt(a.length-1)==="/"?"":"&id=")+encodeURIComponent(this.id)},methodUrl:function(a){if(a=="delete"){return options.hasPrettyUrls?options.endPoint+"/"+this.attributes.id:options.deleteEndPoint+"&id="+this.attributes.id}else{if(a=="update"){return options.hasPrettyUrls?options.endPoint+"/"+this.attributes.id:options.updateEndPoint+"&id="+this.attributes.id}else{if(a=="create"){return options.hasPrettyUrls?options.endPoint+"/"+this.attributes.id:options.createEndPoint+"&id="+this.attributes.id}}}return false},sync:function(c,b,a){if(b.methodUrl&&b.methodUrl(c.toLowerCase())){a=a||{};a.url=b.methodUrl(c.toLowerCase())}Backbone.sync(c,b,a)},initialize:function(){}});var Submissions=Backbone.Collection.extend({url:options.endPoint,model:Submission,pager:{},sort_attribute:App.Options.sort_attribute,initialize:function(){_.bindAll(this,"parse","destroyModelsByIds","loadPager","getPage","reloadPage","showPage","firstPage","lastPage","nextPage","previousPage","searchPage");if(options.hasPrettyUrls){this.model=Backbone.Model}this.pager.currentPage=1;this.keywords="";this.startDate="";this.endDate="";this.sort_attribute=App.Options.sort_attribute;this.listenTo(this,"destroy",this.onDestroy);this.listenTo(this,"sync",this.onSync)},onSync:function(b,c,a){if(!_.isObject(b.models)){if((c.updated_at>c.created_at)||(!_.isNull(c["new"])&&!c["new"])){}else{this.firstPage().then(function(){App.Router.navigate("",{trigger:true})})}return false}},onDestroy:function(a){this.fetchPage()},parse:function(a){this.pager=a._meta;return a.items},updateModelsByIds:function(c,b){var a=this;$.ajax({url:options.updateAllEndPoint,type:"POST",data:{id:options.formID,ids:c,attributes:b}}).done(function(d){if(d.success&&(d.itemsUpdated>0)){a.reloadPage()}else{alert(options.i18n.errorOnUpdate)}}).fail(function(d,e){alert(options.i18n.errorOnUpdate)})},destroyModelsByIds:function(b){var a=this;$.ajax({url:options.deleteAllEndPoint,type:"POST",data:{id:options.formID,ids:b}}).done(function(c){if(c.success&&(c.itemsDeleted>0)){if(a.pager.currentPage==a.pager.pageCount){a.previousPage()}else{a.reloadPage()}}else{alert(options.i18n.errorOnDelete)}}).fail(function(c,d){alert(options.i18n.errorOnDelete)})},loadPager:function(){this.pager.pageCount=Math.ceil(this.pager.totalCount/this.pager.perPage);this.pager.prev=false;this.pager.next=false;this.pager.range={min:this.pager.totalCount?((this.pager.currentPage-1)*this.pager.perPage+1):this.pager.totalCount,max:Math.min(this.pager.totalCount,this.pager.currentPage*this.pager.perPage)};if(this.pager.currentPage>1){this.pager.prev=this.pager.currentPage-1}if(this.pager.currentPage<this.pager.pageCount){this.pager.next=this.pager.currentPage+1}return this},getPage:function(){this.loadPager();return this.pager},reloadPage:function(){return this.fetchPage()},showPage:function(a){this.pager.currentPage=a;return this.fetchPage()},nextPage:function(){++this.pager.currentPage;return this.fetchPage()},previousPage:function(){--this.pager.currentPage;return this.fetchPage()},firstPage:function(){this.pager.currentPage=1;return this.fetchPage()},lastPage:function(){this.pager.currentPage=this.pager.pageCount;return this.fetchPage()},searchPage:function(a){this.keywords=a;this.pager.currentPage=1;return this.fetchPage()},filterPage:function(a,b){this.startDate=a;this.endDate=b;this.pager.currentPage=1;return this.fetchPage()},sortPage:function(a){this.sort_attribute=a;App.Options.sort_attribute=a;App.set("form_"+options.formID+"_options",App.Options);this.pager.currentPage=1;return this.fetchPage()},fetchPage:function(){var a=this;return this.fetch({data:$.param({id:options.formID,q:this.keywords,sort:this.sort_attribute,page:this.pager.currentPage,start:this.startDate,end:this.endDate}),reset:true,success:function(){a.trigger("sync:page")}})}});var Router=Backbone.Router.extend({views:{},initialize:function(a){this.main=a.main;this.submissions=a.submissions;this.routesHit=0;Backbone.history.on("route",function(){this.routesHit++},this)},routes:{"":"index",back:"back",add:"add","edit/:id":"edit","view/:id":"view"},closeViews:function(){_.invoke(this.views,"close")},index:function(){this.closeViews();this.views.navView=new App.NavView({page:options.i18n.index,collection:this.submissions});this.main.html(this.views.navView.render().el);this.views.submissionsView=new App.SubmissionsView({collection:this.submissions});this.main.append(this.views.submissionsView.render().el)},back:function(){if(this.routesHit>1){this.routesHit=this.routesHit-2;window.history.back()}else{if(Backbone.history.getFragment()!="/"){this.routesHit=0}this.navigate("",{trigger:true,replace:true})}},bulk:function(){this.closeViews();this.views.navView=new App.NavView({page:options.i18n.bulkActions});this.main.html(this.views.navView.render().el);this.views.bulkView=new App.BulkView();this.main.append(this.views.bulkView.render().el)},add:function(){this.closeViews();this.views.navView=new App.NavView({page:options.i18n.addSubmission,collection:this.submissions});this.main.html(this.views.navView.render().el);this.views.formView=new App.FormView({subtitle:options.i18n.addSubmission,collection:this.submissions});this.main.append(this.views.formView.render().el)},edit:function(a){this.closeViews();this.views.navView=new App.NavView({page:options.i18n.editSubmission,collection:this.submissions});this.main.html(this.views.navView.render().el);this.views.formView=new App.FormView({id:a,subtitle:options.i18n.editSubmission,model:this.submissions.get(a)});this.main.append(this.views.formView.render().el)},view:function(a){this.closeViews();this.views.navView=new App.NavView({page:options.i18n.submissionDetails,collection:this.submissions});this.main.html(this.views.navView.render().el);this.views.detailView=new App.DetailView({id:a,model:this.submissions.get(a)});this.main.append(this.views.detailView.render().el);this.views.detailView.afterAppend()}});App.init=function(){var a=JSON.parse(options.settings);if(!_.isEmpty(a)){App.Options=a}App.Options.emptyFields=options.emptyFields;App.Submissions=new Submissions();return App.Submissions.fetchPage().then(function(){App.Router=new Router({main:$("#main"),submissions:App.Submissions});Backbone.history.start()})};$(function(){App.init()});