_.each(["Model","Collection"],function(a){var c=Backbone[a];var b=c.prototype.fetch;c.prototype.fetch=function(){this.trigger("fetch",this);return b.apply(this,arguments)}});var PubSub=_.extend({},Backbone.Events);Backbone.View.prototype.close=function(){this.remove();this.unbind();if(this.onClose){this.onClose()}};_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var App=App||{};App.Data={variables:options.variables,actions:[{name:"toShow",label:options.i18n.show,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"toHide",label:options.i18n.hide,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"toEnable",label:options.i18n.enable,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"toDisable",label:options.i18n.disable,fields:[{label:"",name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{label:options.i18n.copy,name:"copy",fields:[{label:options.i18n.from,name:"original",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"originalField",fieldType:"select_multiple",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"originalElement",fieldType:"text"}]},{label:options.i18n.value,name:"value",fields:[{label:"",name:"originalValue",fieldType:"textarea"}]}]},{label:options.i18n.to,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{label:options.i18n.math,name:"performArithmeticOperations",fields:[{label:options.i18n.perform,name:"operator",fieldType:"select",options:[{label:options.i18n.addition,name:"+"},{label:options.i18n.subtraction,name:"-"},{label:options.i18n.multiplication,name:"*"},{label:options.i18n.division,name:"/"},{label:options.i18n.remainder,name:"%"}]},{label:options.i18n.of,name:"operands",fieldType:"select_multiple",options:options.fields},{label:options.i18n.andSetResultTo,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{label:options.i18n.evaluate,name:"evaluateMathFormula",fields:[{label:options.i18n.formula,name:"formula",fieldType:"textarea"},{label:options.i18n.andSetResultTo,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]}]},{name:"formatNumber",label:options.i18n.formatNumber,fields:[{label:options.i18n.of,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]},{label:"As",name:"format",fieldType:"text"}]},{label:options.i18n.formatText,name:"formatText",fields:[{label:options.i18n.from,name:"original",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"originalField",fieldType:"select_multiple",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"originalElement",fieldType:"text"}]}]},{label:options.i18n.to,name:"target",fieldType:"select",options:[{label:options.i18n.field,name:"field",fields:[{label:"",name:"targetField",fieldType:"select",options:options.fields}]},{label:options.i18n.element,name:"element",fields:[{label:"",name:"targetElement",fieldType:"text"}]}]},{label:options.i18n.as,name:"format",fieldType:"textarea"}]},{name:"skip",label:options.i18n.skip,fields:[{name:"step",label:options.i18n.toStep,fieldType:"select",options:options.steps}]},{name:"form",label:options.i18n.form,fields:[{label:options.i18n.action,name:"action",fieldType:"select",options:[{label:options.i18n.submit,name:"submit"},{label:options.i18n.reset,name:"reset"},{label:options.i18n.nextStep,name:"nextStep"},{label:options.i18n.previousStep,name:"previousStep"}]}]}],variable_type_operators:{text:textOperators,tel:textOperators,color:colorOperators,url:textOperators,password:textOperators,number:numberOperators,range:numberOperators,date:dateOperators,"datetime-local":dateOperators,time:dateOperators,month:dateOperators,week:dateOperators,email:emailOperators,textarea:textOperators,select:selectOperators,checkbox:checkboxOperators,radio:radioOperators,signature:signatureOperators,hidden:hiddenOperators,file:fileOperators,button:buttonOperators,form:formOperators}};App.ActionsView=Backbone.View.extend({template:_.template($("#actions-template").html()),events:{"click button#add-rule":function(a){a.preventDefault();this.collection.add({form_id:options.formID,status:1,opposite:1})}},render:function(){this.el.innerHTML=this.template();return this}});App.RulesView=Backbone.View.extend({className:"rule-builder",subViews:{},template:_.template($("#rules-template").html()),events:{"update-sort":"updateSort"},initialize:function(){this.listenTo(this.collection,"add",this.onAdd);this.listenTo(this.collection,"destroy",this.onDestroy);PubSub.on("rule:duplicated",this.onDuplicate,this);$(this.el).sortable({placeholder:"ui-sortable-placeholder",cancel:"input,textarea,button,select,option,a,span,.rule-builder-conditions,.rule-builder-actions,[contenteditable]",stop:function(a,b){b.item.trigger("drop",b.item.index())}});$("body").on("click",'textarea[name="format"], textarea[name="formula"]',function(b){var a=$(b.currentTarget);a.textcomplete("destroy");a.textcomplete([{match:function(){return/(\.*){(\w*)$/},search:function(d,e,c){$.post(options.fieldListUrl,{id:options.formID,term:_.isUndefined(c[2])?"":c[2],_csrf:$("meta[name=csrf-token]").attr("content")}).done(function(f){if(!_.isUndefined(f.data)&&_.isObject(f.data)){var g=Object.keys(f.data).map(function(h){var i={};i[h]="<span>"+h+"</span>"+f.data[h];return i});e($.map(g,function(i){var h=i[Object.keys(i)[0]];return h.indexOf(d)===0?i:null}))}else{e([])}})},template:function(c){return c[Object.keys(c)[0]]},index:1,replace:function(d){var c=Object.keys(d)[0];return"{{"+c+"}} "}}],{zIndex:1500,maxCount:-1})})},updateSort:function(d,b,a){this.collection.remove(b,{silent:true});this.collection.add(b,{at:a,silent:true});var c=this.collection.pluck("id");var e={form_id:options.formID,ids:c};$.ajax({data:e,type:"POST",url:options.positionEndPoint}).done(function(){$.notify({icon:"glyphicon glyphicon-ok",message:options.i18n.orderUpdated},{type:"success",placement:{from:"bottom",align:"center"},delay:1000,template:'<div data-notify="container" class="col-xs-9 col-sm-3 alert alert-{0}" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã—</button><span data-notify="icon"></span> <span data-notify="title">{1}</span> <span data-notify="message">{2}</span><div class="progress" data-notify="progressbar"><div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'})})},onAdd:function(a){this.addSubview(a)},onDuplicate:function(a){this.collection.add(a.toJSON())},onDestroy:function(a){this.subViews[a.cid].close()},addSubview:function(a){this.subViews[a.cid]=new App.RuleView({model:a});this.$el.append(this.subViews[a.cid].render().el)},closeSubviews:function(){_.invoke(this.subViews,"close")},onClose:function(){this.closeSubviews();this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},render:function(){this.closeSubviews();this.el.innerHTML=this.template();var a=document.createDocumentFragment();var b=this;this.collection.each(function(c){b.subViews[c.cid]=new App.RuleView({model:c});a.appendChild(b.subViews[c.cid].render().el)});this.$el.empty();this.$el.append(a);return this}});App.RuleView=Backbone.View.extend({template:_.template($("#rule-template").html()),tagName:"div",className:"rules-group-container",events:{"click form .btn":"changeModel","remove .remove":"changeModel","change :input":"changeModel","click .save-rule":"saveModel","click .duplicate-rule":"duplicateModel","click .delete-rule":"deleteModel",drop:"drop"},initialize:function(){this.listenTo(this.model,"change",this.onChange)},drop:function(b,a){this.$el.trigger("update-sort",[this.model,a])},onChange:function(){this.render()},changeModel:function(a){a.preventDefault();this.$(".label-warning").show()},saveModel:function(d){d.preventDefault();var b=this.$("#"+this.model.cid+"name").val();var f=this.$("#"+this.model.cid+"conditions");var g=this.$("#"+this.model.cid+"actions");var a=this.$("#"+this.model.cid+"status").is(":checked")?1:0;var e=this.$("#"+this.model.cid+"opposite").is(":checked")?1:0;this.model.set({name:b,conditions:JSON.stringify(f.conditionsBuilder("data")),actions:JSON.stringify(g.actionsBuilder("data")),status:a,opposite:e,ordinal:this.model.collection.indexOf(this.model)});var c=this;this.model.save(null,{success:function(i){var h=i.collection.indexOf(i);c.$(".label-warning").hide();c.$el.trigger("update-sort",[i,h])}})},duplicateModel:function(b){b.preventDefault();var a=this.model.clone();a.unset("id");PubSub.trigger("rule:duplicated",a)},deleteModel:function(a){a.preventDefault();if(this.model.isNew()){this.model.destroy()}else{if(confirm(options.i18n.areYouSureDeleteItem)){this.model.destroy()}}return false},onClose:function(){this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},displayRuleBuilder:function(){var b=this.$("#"+this.model.cid+"conditions");var c=this.$("#"+this.model.cid+"actions");if(this.model.has("conditions")&&_.isString(this.model.get("conditions"))){b.conditionsBuilder($.extend({},App.Data,{data:JSON.parse(this.model.get("conditions"))}))}else{b.conditionsBuilder(App.Data)}if(this.model.has("actions")&&_.isString(this.model.get("actions"))){c.actionsBuilder($.extend({},App.Data,{data:JSON.parse(this.model.get("actions"))}))}else{c.actionsBuilder(App.Data)}var a=this.$(".rule-name");var d=this.$("#"+this.model.cid+"name");a.editable({multiline:false,exitKeys:["escape","enter","tab"],save:function(e){d.val(a.text().trim()).trigger("change")},validate:function(e){return a.text().trim().length<255}})},render:function(){this.el.innerHTML=this.template({cid:this.model.cid,rule:this.model.toJSON()});if(this.model.isNew()){this.$(".label-warning").show()}this.displayRuleBuilder();return this}});var Router=Backbone.Router.extend({views:{},initialize:function(a){this.main=a.main;this.rules=a.rules},routes:{"":"index"},closeViews:function(){_.invoke(this.views,"close")},index:function(){this.closeViews();this.views.rulesView=new App.RulesView({collection:this.rules});this.main.append(this.views.rulesView.render().el);this.views.actionsView=new App.ActionsView({collection:this.rules});this.main.append(this.views.actionsView.render().el)}});var Rule=Backbone.Model.extend({url:function(){var a=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew()){return a}return a+(a.charAt(a.length-1)==="/"?"":"&id=")+encodeURIComponent(this.id)},methodUrl:function(a){if(a=="delete"){return options.deleteEndPoint+"&id="+this.attributes.id}else{if(a=="update"){return options.updateEndPoint+"&id="+this.attributes.id}else{if(a=="create"){return options.createEndPoint+"&id="+this.attributes.id}}}return false},sync:function(c,b,a){if(b.methodUrl&&b.methodUrl(c.toLowerCase())){a=a||{};a.url=b.methodUrl(c.toLowerCase())}Backbone.sync(c,b,a)},initialize:function(){}});var Rules=Backbone.Collection.extend({url:options.endPoint,model:Rule,initialize:function(){if(options.hasPrettyUrls){this.model=Backbone.Model}},comparator:function(a){return a.get("ordinal")},parse:function(a){this.pager=a._meta;return a.items},fetchPage:function(){var a=this;return this.fetch({data:$.param({id:options.formID}),reset:true,success:function(){a.trigger("sync:page")}})}});App.init=function(){App.Rules=new Rules();return App.Rules.fetchPage().then(function(){App.Router=new Router({main:$("#main"),rules:App.Rules});Backbone.history.start()})};$(function(){App.init()});