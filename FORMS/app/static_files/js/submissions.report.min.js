_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var gridEl,gridStack,charts;$(document).ready(function(){d3.json(options.endPoint).then(function(r){gridEl=$(".grid-stack");gridEl.gridstack({cell_height:90,vertical_margin:10});gridStack=gridEl.data("gridstack");charts=[];var p="#475e98";var o="#9B59B6";var n="#F8B700";var m="#78CC00";var l="#7B71C5";var k="#56B2EA";var i="#E064CD";var e=[p,o,n,m,l,k,i,p,o,n,m,l,k,i];dc.config.defaultColors(e);var f=false;r.forEach(function(t){var s=t.created_at*1000;t.date=new Date(s)});var b=crossfilter(r);var a=b.groupAll();var q=dc.dataCount(".data-count").crossfilter(b).groupAll(a);q.render();var h=b.dimension(function(s){return s.date});$("#reset-all").on("click",function(s){s.preventDefault();h.filter(null);dc.filterAll(null);dc.renderAll()});$("#report-filter").on("submit",function(u){u.preventDefault();var t=$("#from-date-disp").val();var s=$("#to-date-disp").val();if(t.length>0&&s.length>0){h.filter(dc.filters.RangedFilter(new Date(t),new Date(s)));dc.redrawAll()}else{if(t.length===0&&s.length===0){h.filter(null);dc.redrawAll()}}});var c=function(B,z,s,C,D,A,E,v){var u=$("#widget").html();var t=_.template(u)({title:B,type:z,name:s,label:C});gridStack.add_widget($(t),D,A,E,v)};var j=function(u,w){var y=b.dimension(function(z){return z[u]});var t=y.group();var x=$("div").find("[data-name='"+u+"']");var v=x.width();var s=x.height();if(w==="pie"){charts[u]=dc.pieChart("#"+u);charts[u].width(v-80).height(s-80).slicesCap(4).renderTitle(true).legend(dc.legend()).renderLabel(false).dimension(y).group(t)}else{if(w==="donut"){charts[u]=dc.pieChart("#"+u);charts[u].width(v-80).height(s-80).dimension(y).group(t).innerRadius(Math.round((s-80)*20/100)).renderLabel(true).renderTitle(true)}else{if(w==="row"){charts[u]=dc.rowChart("#"+u);charts[u].width(v-40).height(s-80).dimension(y).group(t).elasticX(true)}else{if(w==="bar"){charts[u]=dc.barChart("#"+u);charts[u].width(v-10).height(s-80).x(d3.scaleBand()).xUnits(dc.units.ordinal).brushOn(false).dimension(y).barPadding(0.1).outerPadding(0.05).on("renderlet",function(z){z.selectAll("rect").attr("fill",function(B,A){return e[A]})}).group(t)}}}}charts[u].render()};var d=function(t,s,u){var v='<div class="alert alert-'+u+'" role="alert">';v+='<button type="button" class="close" data-dismiss="alert" aria-label="Close">';v+='<span aria-hidden="true">&times;</span>';v+="</button>";v+='<p><span class="glyphicon glyphicon-ok-sign"></span> '+s+"</p>";v+="</div>";$(t).append(v)};var g=function(s){$(s).empty()};_.each(options.charts,function(s){c(s.title,s.type,s.name,s.label,s.gsX,s.gsY,s.gsW,s.gsH);j(s.name,s.type)});gridStack.disable();gridEl.on("resizestop",function(){f=true});gridEl.on("change",function(y,t){if(f){var x=_.first(t).el;var u=x.data("name");var w=x.data("type");var v=x.width();var s=x.height();if(w==="bar"){charts[u].width(v-10).height(s-80).rescale().redraw()}else{if(w==="row"){charts[u].width(v-40).height(s-80).redraw()}else{if(w==="donut"){charts[u].width(v-80).height(s-80).innerRadius(Math.round((s-80)*20/100)).redraw()}else{charts[u].width(v-80).height(s-80).redraw()}}}}f=false});window.deleteChart=function(t){var s=$(t).data("name");var u=$("div").find("[data-name='"+s+"']");gridStack.remove_widget(u)};$("#enable").click(function(s){s.preventDefault();gridStack.enable();gridEl.addClass("grid-editable");$(".btn-for-toggle").toggle()});$("#disable").click(function(s){s.preventDefault();gridStack.disable();gridEl.removeClass("grid-editable");$(".btn-for-toggle").toggle()});$("#reset").click(function(s){s.preventDefault();gridStack.remove_all()});$("#formModal").on("show.bs.modal",function(w){var x=$(w.relatedTarget);var y=x.data("title");var v=$(this);if(typeof y==="undefined"){v.find("#chartTitle").val("");v.find("#chartType option:eq(0)").prop("selected",true);v.find("#field option:eq(0)").prop("selected",true);v.find("#field").prop("disabled",false)}else{var t=x.data("name");var s=x.data("label");var u=x.data("type");v.find("#chartTitle").val(y);v.find('#chartType option[value="'+u+'"]').prop("selected",true);v.find('#field option[value="'+t+'"]').prop("selected",true);v.find("#field").prop("disabled",true)}});$("#saveChart").on("click",function(A){A.preventDefault();var t=$("#chartTitle").val();var C=$("#chartType").val();var B=$("#field");var s=B.val();var u=B.children(":selected").text();if($("#"+s).length){var z=$("div").find("[data-name='"+s+"']");var E=z.data("gs-x");var D=z.data("gs-y");var F=z.data("gs-width");var v=z.data("gs-height");gridStack.remove_widget(z);c(t,C,s,u,E,D,F,v);j(s,C)}else{if(t.length===0){g("#modal-messages");d("#modal-messages","<strong>"+options.i18n.error+"</strong> "+options.i18n.errorMessage,"danger");return false}c(t,C,s,u,0,0,3,3);j(s,C)}});$("#saveReport").click(function(u){u.preventDefault();var s=_.map($(".grid-stack .grid-stack-item:visible"),function(w){w=$(w);var x=w.data("_gridstack_node");return{name:w.attr("data-name"),label:w.attr("data-label"),title:w.attr("data-title"),type:w.attr("data-type"),width:120,height:120,gsX:x.x,gsY:x.y,gsW:x.width,gsH:x.height}});var t={report:JSON.stringify(s),_csrf:options._csrf};var v=$.ajax({method:"POST",url:options.endPoint,dataType:"json",data:t}).done(function(w){if(w.success&&w.id>0){g("#messages");d("#messages","<strong>"+options.i18n.success+"</strong> "+options.i18n.updatedMessage,"success")}else{g("#messages");d("#messages","<strong>"+options.i18n.error+"</strong> "+options.i18n.errorOnUpdate,"danger")}}).fail(function(w){g("#messages");d("#messages","<strong>"+options.i18n.success+"</strong>"+options.i18n.errorOnUpdate,"danger");console.error(w)})})})});