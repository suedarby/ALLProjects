(function(b){window._registeredConditionsDomEvents=false;b.fn.conditionsBuilder=function(d){if(d==="data"){var c=b(this).eq(0).data("conditionsBuilder");return c.collectData()}else{return b(this).each(function(){var e=new a(this,d);b(this).data("conditionsBuilder",e)})}};function a(d,c){this.element=b(d);this.options=c||{};this.selectFieldsCache=false;this.init()}a.prototype={init:function(){this.fields=this.denormalizeOperators(this.options.variables,this.options.variable_type_operators);this.data=this.options.data||{all:[]};var e=this.buildRules(this.data);if(!window._registeredConditionsDomEvents){var d=b("body");var c=this;d.on("click",".add-condition",function(h){h.preventDefault();var g=c.fields[0];var i={all:[{name:g.value,operator:g.operators[0],value:null}]};b(h.currentTarget).closest(".conditional").append(c.buildConditional(i))});d.on("click",".remove-condition",function(f){f.preventDefault();b(f.currentTarget).closest(".conditional").remove();b(this).trigger("remove")});d.on("click",".add-rule",function(h){h.preventDefault();var g=c.fields[0];var i={name:g.value,operator:g.operators[0],value:null};b(h.currentTarget).closest(".conditional").append(c.buildRule(i))});d.on("click",".remove-rule",function(f){f.preventDefault();b(f.currentTarget).closest(".rule").remove();b(this).trigger("remove")});window._registeredConditionsDomEvents=true}this.element.empty();this.element.html(e)},denormalizeOperators:function(d,c){return b.map(d,function(e){e.operators=c[e.fieldType];return e})},collectData:function(){return this.collectDataFromNode(this.element.find("> .conditional"))},collectDataFromNode:function(e){var c=null;var f=this;if(e.is(".conditional")){c=e.find("> .all-any-none-wrapper > .all-any-none").val()}if(c){var d={};d[c]=[];e.find("> .conditional, > .rule").each(function(){d[c].push(f.collectDataFromNode(b(this)))});return d}return{name:e.find(".field").val(),operator:e.find(".operator").val(),value:e.find(".value").val()}},buildRules:function(c){return this.buildConditional(c)||this.buildRule(c)},buildConditional:function(m){var g;if(m.all){g="all"}else{if(m.any){g="any"}else{if(m.none){g="none"}}}if(!g){return}var k=document.createElement("div");k.classList.add("conditional");k.classList.add(g);var c=document.createElement("div");c.classList.add("all-any-none-wrapper");var l=document.createElement("select");l.classList.add("all-any-none");l.classList.add("form-control");var v=document.createElement("option");v.value="all";v.innerHTML=options.i18n.all;v.selected=g==="all";l.appendChild(v);var u=document.createElement("option");u.value="any";u.innerHTML=options.i18n.any;u.selected=g==="any";l.appendChild(u);var s=document.createElement("option");s.value="none";s.innerHTML=options.i18n.none;s.selected=g==="none";l.appendChild(s);var o=document.createElement("span");o.textContent=options.i18n.followingConditions;c.appendChild(l);c.appendChild(o);k.append(c);var e=document.createElement("span");e.classList.add("glyphicon");e.classList.add("glyphicon-plus");e.textContent=" ";var q=document.createElement("a");q.classList.add("add-rule");q.classList.add("btn");q.classList.add("btn-warning");q.classList.add("btn-xs");q.textContent=options.i18n.addCondition;q.href="#";q.prepend(e);k.append(q);var r=document.createElement("span");r.classList.add("glyphicon");r.classList.add("glyphicon-plus");r.textContent=" ";var f=document.createElement("a");f.classList.add("add-condition");f.classList.add("btn");f.classList.add("btn-warning");f.classList.add("btn-xs");f.textContent=options.i18n.addGroup;f.href="#";f.prepend(r);k.append(f);var t=document.createElement("span");t.classList.add("glyphicon");t.classList.add("glyphicon-remove");t.textContent=" ";var h=document.createElement("a");h.classList.add("remove-condition");h.classList.add("btn");h.classList.add("btn-danger");h.classList.add("btn-xs");h.textContent=options.i18n.deleteText;h.href="#";h.prepend(t);k.append(h);var j=m[g];var p=j.length;for(var n=0;n<p;n++){var d=this.buildRules(j[n]);if(d){k.appendChild(d)}}return k},buildRule:function(d){var j=this;var c=document.createElement("div");c.classList.add("rule");var p=document.createElement("select");p.classList.add("field");p.classList.add("form-control");var q=document.createElement("option");var k=this.fields.length;for(var g=0;g<k;g++){var o=this.fields[g];var h=q.cloneNode(true);h.value=o.name;h.innerHTML=o.label;h.selected=d.name===o.name;h.dataset.idx=g;p.appendChild(h)}var f=document.createElement("select");f.classList.add("operator");f.classList.add("form-control");f.addEventListener("change",function(y){var z=b(this);var w=z.find("> :selected");var s=z.parents(".rule");var r=s.find(".field");var C=s.find(".value");switch(w.data("fieldType")){case"none":z.after(b("<input>",{type:"hidden","class":"value form-control"}));break;case"text":z.after(b("<input>",{type:"text","class":"value form-control"}));break;case"email":z.after(b("<input>",{type:"email","class":"value form-control"}));break;case"number":z.after(b("<input>",{type:"number","class":"value form-control"}));break;case"color":z.after(b("<input>",{type:"color","class":"value form-control"}));break;case"range":z.after(b("<input>",{type:"range","class":"value form-control"}));break;case"textarea":z.after(b("<textarea>",{"class":"value form-control"}));break;case"select":var A=b("<select>",{"class":"value form-control"});var u=r.find("> :selected");var v=u.data("idx");var D=j.fields[v].options;var x=D.length;for(var v=0;v<x;v++){var t=D[v];A.append(b("<option>",{text:t.label||t.value,value:t.value}))}z.after(A);break;case"select_multiple":var u=r.find("> :selected");var v=u.data("idx");var D=j.fields[v].options;var B=D.length>10?10:D.length;var A=b("<select class='value form-control' multiple size='"+B+"''></select>");var x=D.length;for(var v=0;v<x;v++){var t=D[v];A.append(b("<option>",{text:t.label||t.value,value:t.value}))}z.after(A);break}C.remove()});var n=document.createElement("span");n.classList.add("glyphicon");n.classList.add("glyphicon-remove");n.textContent=" ";var m=document.createElement("a");m.classList.add("remove-rule");m.classList.add("btn");m.classList.add("btn-danger");m.classList.add("btn-xs");m.textContent=options.i18n.deleteText;m.href="#";m.prepend(n);c.appendChild(p);c.appendChild(f);c.appendChild(m);p.addEventListener("change",function(w){var s=j.operatorsFor(b(w.target).val());f.innerHTML="";var r=s.length;for(var u=0;u<r;u++){var t=s[u];var v=q.cloneNode(true);v.value=t.name;v.innerHTML=t.label||t.name;v.selected=d.operator===t.name;v.dataset.fieldType=t.fieldType;f.appendChild(v)}var w=new Event("change");f.dispatchEvent(w)});var l=new Event("change");p.dispatchEvent(l);c.querySelector(".value").value=d.value;return c},operatorsFor:function(f){var c=this.fields.length;for(var d=0;d<c;d++){var e=this.fields[d];if(e.name===f){return e.operators}}}}})(jQuery);