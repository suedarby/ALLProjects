(function(b){window._registeredActionsDomEvents=false;b.fn.actionsBuilder=function(d){if(d==="data"){var c=b(this).eq(0).data("actionsBuilder");return c.collectData()}else{return b(this).each(function(){var e=new a(this,d);b(this).data("actionsBuilder",e)})}};function a(d,c){this.element=b(d);this.options=c||{};this.init()}a.prototype={init:function(){this.fields=this.options.actions;this.data=this.options.data||[];if(!window._registeredActionsDomEvents){var d=b("body");var c=this;d.on("click",".add-action",function(g){g.preventDefault();var f=c.buildAction({});b(g.currentTarget).closest(".actions").append(f);var g=new Event("change");f.querySelector("select").dispatchEvent(g)});d.on("click",".remove-action",function(f){f.preventDefault();b(f.currentTarget).closest(".action").remove();b(this).trigger("remove")});window._registeredActionsDomEvents=true}var e=this.buildActions(this.data);this.element.empty();this.element.html(e)},buildActions:function(h){var d=document.createElement("div");d.classList.add("actions");var r=document.createElement("div");r.classList.add("action-buttons");var u=document.createElement("span");u.style.cssText="margin-right:20px;display:inline-block";u.textContent=options.i18n.followingActions;r.appendChild(u);var q=document.createElement("span");q.classList.add("glyphicon");q.classList.add("glyphicon-plus");q.textContent=" ";var t=document.createElement("a");t.classList.add("add-action");t.classList.add("btn");t.classList.add("btn-success");t.classList.add("btn-xs");t.textContent=options.i18n.addAction;t.href="#";t.insertBefore(q,t.firstChild);r.appendChild(t);d.appendChild(r);var m=h.length;for(var j=0;j<m;j++){var l=h[j];var g=this.buildAction(l);var k=[l],s;while(s=k.shift()){var c=g.querySelector("[name='"+s.name+"']");if(c){if(Array.isArray(s.value)&&typeof c.options!=="undefined"){var p=c.options.length;for(var f=0;f<p;f++){if(s.value.indexOf(c.options[f].value)!==-1){c.options[f].selected=true}}}else{c.value=s.value}var n=new Event("change");c.dispatchEvent(n)}if(s.fields){k=k.concat(s.fields)}}d.appendChild(g)}return d},buildAction:function(d){var c=document.createElement("div");c.classList.add("action");var j=document.createElement("div");j.classList.add("subfields");var n=document.createElement("select");n.classList.add("action-select");n.classList.add("form-control");n.name="action-select";var p=document.createElement("option");var h=this.fields.length;for(var e=0;e<h;e++){var f=p.cloneNode(true);f.value=this.fields[e].name;f.innerHTML=this.fields[e].label;n.appendChild(f)}var g=this;n.addEventListener("change",function(){var t=this.value;var s=g._findField(t);j.innerHTML="";if(s.fields){var q=s.fields.length;for(var r=0;r<q;r++){j.appendChild(g.buildField(s.fields[r]))}}c.classList.add("action");c.classList.add("val")});var l=document.createElement("span");l.classList.add("glyphicon");l.classList.add("glyphicon-remove");l.textContent=" ";var k=document.createElement("a");k.classList.add("remove-action");k.classList.add("btn");k.classList.add("btn-danger");k.classList.add("btn-xs");k.textContent=options.i18n.deleteText;k.href="#";k.prepend(l);var m=this._findField(d.name);if(m){n.value=m.name;if(d.fields){var h=d.fields.length;for(e=0;e<h;e++){var o=j.querySelector("[name='"+d.fields[e].name+"']");o.value=d.fields[e].label}}}c.appendChild(n);c.appendChild(j);c.appendChild(k);return c},buildField:function(q){var c=document.createElement("div");c.classList.add("field");var k=document.createElement("div");k.classList.add("subfields");var r=document.createElement("label");r.classList.add("control-label");r.textContent=q.label;c.appendChild(r);var l=this;if(q.fieldType==="select"){var s=document.createElement("select");s.classList.add("form-control");s.classList.add("field-select");s.name=q.name;var u=document.createElement("option");var m=q.options.length;for(var h=0;h<m;h++){var g=q.options[h];var j=u.cloneNode(true);j.value=g.name;j.innerHTML=g.label;j.dataset.idx=h;s.appendChild(j)}s.addEventListener("change",function(){var v=b(this).find("> :selected");var p=v.data("idx");var x=q.options[p];k.innerHTML="";if(typeof x!=="undefined"&&typeof x.fields!=="undefined"){var e=x.fields.length;for(var p=0;p<e;p++){var w=x.fields[p];k.appendChild(l.buildField(w))}}});var n=new Event("change");s.dispatchEvent(n);c.appendChild(s)}else{if(q.fieldType==="select_multiple"){var s=document.createElement("select");s.classList.add("form-control");s.classList.add("field-select-multiple");s.name=q.name;s.multiple=true;var u=document.createElement("option");var m=q.options.length;for(var h=0;h<m;h++){var g=q.options[h];var j=u.cloneNode(true);j.value=g.name;j.innerHTML=g.label;j.dataset.idx=h;s.appendChild(j)}s.addEventListener("change",function(){var v=b(this).find("> :selected");var p=v.data("idx");var x=q.options[p];k.innerHTML="";if(typeof x!=="undefined"&&typeof x.fields!=="undefined"){var e=x.fields.length;for(var p=0;p<e;p++){var w=x.fields[p];k.appendChild(l.buildField(w))}}});var n=new Event("change");s.dispatchEvent(n);c.appendChild(s)}else{if(q.fieldType==="text"){var o=document.createElement("input");o.setAttribute("type","text");o.classList.add("form-control");o.name=q.name;c.appendChild(o)}else{if(q.fieldType==="textarea"){var f="textarea-"+Math.floor(Math.random()*100000);var t=document.createElement("textarea");t.classList.add("form-control");t.name=q.name;t.id=f;c.appendChild(t)}}}}if(q.hint){var d=document.createElement("p");d.classList.add("hint");d.innerText=q.hint;c.appendChild(d)}c.appendChild(k);return c},collectData:function(c){c=c||this.element.find(".action");var d=[];var e=this;c.each(function(){var g=b(this).find("> :input, > .jstEditor > :input");var f=b(this).find("> .subfields > .field");var h={name:g.attr("name"),value:g.val()};if(f.length>0){h.fields=e.collectData(f)}d.push(h)});return d},_findField:function(e){var c=this.fields.length;for(var d=0;d<c;d++){if(this.fields[d].name===e){return this.fields[d]}}}}})(jQuery);